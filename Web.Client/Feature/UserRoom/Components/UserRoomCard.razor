@using System.Diagnostics.CodeAnalysis
@using global::Shared.RoomSet
@using global::Shared.TakeExam
@using Web.Client.Interfaces
@inject IDialogService Dialog

@{
    if (room == null)
    {
        <MudCard>
            <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="100px" Width="300px"/>
            <MudCardContent>
                <MudSkeleton Width="30%" Height="42px"/>
                <MudSkeleton Width="80%"/>
                <MudSkeleton Width="100%"/>
            </MudCardContent>
            <MudCardActions>
                <MudSpacer/>
                <MudSkeleton Width="105px" Height="40px" Class="ml-3"/>
            </MudCardActions>
        </MudCard>
    }
    else
    {
        <MudCard>
            <MudCardMedia Image="@strImage" Height="100"/>
            <MudCardContent>
                <MudPaper MaxWidth="300px" Elevation="0">
                    <MudText Typo="Typo.h6">@room.Nama</MudText>
                    <MudText Typo="Typo.body2">Kode Ruangan :<b>@room.Kode</b></MudText>
                    <MudStack Row="true" Spacing="2">
                        <MudText Typo="Typo.body2">Mulai : @room.JadwalStart.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</MudText>
                        <MudText Typo="Typo.body2">Selesai : @room.JadwalEnd.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</MudText>
                    </MudStack>
                </MudPaper>


            </MudCardContent>
            <MudCardActions>
                <MudSpacer/>
                @{
                    if (!room.IsActive)
                    {
                        <MudText Typo="Typo.body2">Ujian Belum Dibuka</MudText>
                    }
                    else if (room.JadwalStart.ToLocalTime() > DateTime.Now.ToLocalTime())
                    {
                        <MudText Typo="Typo.body2">Ujian Belum Dimulai</MudText>
                    }
                    else if (room.JadwalEnd.ToLocalTime() < DateTime.Now.ToLocalTime())
                    {
                        <MudText Typo="Typo.body2">Ujian Telah Berakhir</MudText>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="OnLihat">Lihat</MudButton>
                    }
                }


            </MudCardActions>
        </MudCard>
    }
}


@code {
    [Parameter] public UserExam data { get; set; }
    [Parameter] public Room room { get; set; }
    [Parameter] public EventCallback<int> RefreshData { get; set; }

    [Inject] NavigationManager _navigationManager { get; set; }
    [Inject] IRoom _roomRepo { get; set; }

    private string strImage = "/images/room-bg.jpg";
    DialogOptions maxWidth = new() { MaxWidth = MaxWidth.Medium, BackgroundClass = "bg-filter" };

    protected override async Task OnInitializedAsync()
    {
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            room = await _roomRepo.Get(data.RoomId);
            if (room.Thumbnail != null)
            {
                strImage = $"data:image;base64,{Convert.ToBase64String(room.Thumbnail)}";
            }

            StateHasChanged();
        }
    }


    private async Task OnLihat()
    {
        var parameters = new DialogParameters<UserRoomDialog>();
        parameters.Add(x => x.userExam, data);
        parameters.Add(x => x.room, room);
        var form = await Dialog.ShowAsync<UserRoomDialog>("Detail Ruangan", parameters, maxWidth);
        var result = await form.Result;
        if (!result.Canceled)
            await RefreshData.InvokeAsync(1);
    }

}